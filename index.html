<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traction Jackson</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --border: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9e;
            --text-muted: #5a5a6e;
            --accent-green: #00ff88;
            --accent-green-dim: rgba(0, 255, 136, 0.15);
            --accent-red: #ff4757;
            --accent-red-dim: rgba(255, 71, 87, 0.15);
            --accent-yellow: #ffd93d;
            --accent-yellow-dim: rgba(255, 217, 61, 0.15);
            --accent-blue: #4dabf7;
            --accent-blue-dim: rgba(77, 171, 247, 0.15);
            --accent-purple: #a855f7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .app-container { display: flex; min-height: 100vh; }

        /* Sidebar - Minimal */
        .sidebar {
            width: 220px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
            padding: 0 8px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .nav-section { margin-bottom: 32px; }

        .nav-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            padding: 0 12px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-green-dim); color: var(--accent-green); }
        .nav-item svg { width: 18px; height: 18px; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Top Bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .top-bar-left { display: flex; align-items: center; gap: 16px; }
        .top-bar-title { font-size: 16px; font-weight: 600; }
        .top-bar-meta { font-size: 13px; color: var(--text-secondary); }

        /* State Badge */
        .state-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .state-badge.draft { background: var(--bg-card-hover); color: var(--text-secondary); }
        .state-badge.needs-batch { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .state-badge.pending-approval { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .state-badge.ready-to-launch { background: var(--accent-purple); color: white; }
        .state-badge.live { background: var(--accent-green-dim); color: var(--accent-green); }
        .state-badge.completed { background: var(--accent-green); color: var(--bg-dark); }
        .state-badge.paused { background: var(--accent-red-dim); color: var(--accent-red); }

        /* Page Content */
        .page-content { flex: 1; padding: 32px; overflow-y: auto; }

        /* Dashboard */
        .dashboard-hero {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(77, 171, 247, 0.1));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 32px;
        }

        .dashboard-hero h1 { font-size: 28px; margin-bottom: 12px; }
        .dashboard-hero p { color: var(--text-secondary); margin-bottom: 24px; }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }

        .btn-primary {
            background: var(--accent-green);
            color: var(--bg-dark);
        }
        .btn-primary:hover { background: #00dd77; transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { background: var(--border); }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover { color: var(--text-primary); }

        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .btn-lg { padding: 16px 32px; font-size: 16px; }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title { font-size: 16px; font-weight: 600; color: var(--text-secondary); }

        /* Experiment Cards */
        .experiment-list { display: flex; flex-direction: column; gap: 12px; }

        .experiment-card {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            align-items: center;
            gap: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .experiment-card:hover { border-color: var(--text-muted); }

        .experiment-info h3 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .experiment-meta { font-size: 13px; color: var(--text-secondary); }

        .experiment-stats {
            display: flex;
            gap: 24px;
            font-size: 12px;
        }
        .experiment-stats span { color: var(--text-muted); }
        .experiment-stats strong { color: var(--text-secondary); }

        .next-action-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Stepper */
        .stepper-container {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 24px 32px;
        }

        .stepper {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-width: 800px;
            margin: 0 auto;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .step.locked { opacity: 0.4; cursor: not-allowed; }
        .step.completed { background: var(--accent-green-dim); }
        .step.active {
            background: var(--accent-blue-dim);
            box-shadow: 0 0 0 2px var(--accent-blue), 0 0 20px rgba(77, 171, 247, 0.3);
            animation: stepPulse 2s ease-in-out infinite;
        }
        @keyframes stepPulse {
            0%, 100% { box-shadow: 0 0 0 2px var(--accent-blue), 0 0 20px rgba(77, 171, 247, 0.3); }
            50% { box-shadow: 0 0 0 2px var(--accent-blue), 0 0 30px rgba(77, 171, 247, 0.5); }
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            background: var(--border);
            color: var(--text-secondary);
        }

        .step.completed .step-number { background: var(--accent-green); color: var(--bg-dark); }
        .step.active .step-number { background: var(--accent-blue); color: white; }

        .step-label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .step.completed .step-label { color: var(--accent-green); }
        .step.active .step-label { color: var(--accent-blue); }

        .step-status {
            font-size: 11px;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header { margin-bottom: 24px; }
        .card-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .card-subtitle { font-size: 14px; color: var(--text-secondary); }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.15s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            gap: 16px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .checkbox-item.checked {
            border-color: var(--accent-green);
            background: var(--accent-green-dim);
        }
        .checkbox-item input { display: none; }

        /* Video Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .video-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.15s;
        }
        .video-card.approved { border-color: var(--accent-green); box-shadow: 0 0 0 1px var(--accent-green); }
        .video-card.rejected { opacity: 0.4; }

        .video-thumbnail {
            aspect-ratio: 16/9;
            background: var(--bg-card-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 32px;
            position: relative;
            overflow: hidden;
        }

        .video-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-thumbnail-play {
            width: 48px;
            height: 48px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-info { padding: 16px; }
        .video-hook { font-size: 14px; font-weight: 500; margin-bottom: 8px; line-height: 1.4; }
        .video-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        .video-tag {
            font-size: 11px;
            padding: 4px 8px;
            background: var(--bg-card-hover);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        .video-actions {
            display: flex;
            gap: 8px;
        }

        .video-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .video-btn.approve {
            flex: 1.3;
            padding: 12px 10px;
            background: var(--accent-green-dim);
            color: var(--accent-green);
            font-weight: 600;
        }
        .video-btn.approve:hover { background: var(--accent-green); color: var(--bg-dark); }
        .video-btn.reject {
            flex: 0.7;
            background: rgba(255, 71, 87, 0.08);
            color: rgba(255, 71, 87, 0.6);
            font-weight: 400;
        }
        .video-btn.reject:hover { background: var(--accent-red-dim); color: var(--accent-red); }

        .approve-hint {
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            padding: 8px 0;
        }

        /* Sticky Footer */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 220px;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .footer-stats {
            display: flex;
            gap: 24px;
            font-size: 14px;
        }
        .footer-stats span { color: var(--text-secondary); }
        .footer-stats strong.approved { color: var(--accent-green); }
        .footer-stats strong.rejected { color: var(--accent-red); }

        /* Launch Review */
        .review-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .review-item {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 20px;
        }
        .review-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .review-value { font-size: 16px; font-weight: 500; }

        .guardrails-list {
            list-style: none;
        }
        .guardrails-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-secondary);
        }
        .guardrails-list li:last-child { border-bottom: none; }
        .guardrails-list li::before {
            content: "‚Ä¢";
            color: var(--accent-green);
            margin-right: 10px;
        }

        .launch-cta {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), rgba(77, 171, 247, 0.05));
            border-radius: 12px;
            margin-top: 32px;
        }
        .launch-cta p { color: var(--text-secondary); margin-bottom: 20px; }

        /* Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th, .results-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .results-table th {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .results-table td { font-size: 14px; }
        .results-table tr.winner td:first-child { color: var(--accent-green); font-weight: 600; }

        .status-pill {
            display: inline-flex;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-pill.winner { background: var(--accent-green-dim); color: var(--accent-green); }
        .status-pill.paused { background: var(--accent-red-dim); color: var(--accent-red); }

        /* Funnel */
        .funnel {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .funnel-step {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--bg-dark);
            position: relative;
        }
        .funnel-step:first-child { border-radius: 8px 8px 0 0; }
        .funnel-step:last-child { border-radius: 0 0 8px 8px; }

        .funnel-step.highlight { background: var(--accent-red-dim); }

        .funnel-label { flex: 1; font-size: 14px; }
        .funnel-count { font-size: 18px; font-weight: 600; }
        .funnel-drop {
            font-size: 13px;
            color: var(--text-muted);
        }

        .funnel-arrow {
            text-align: center;
            padding: 4px;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Recommendation Box */
        .recommendation-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.08), rgba(77, 171, 247, 0.08));
            border: 2px solid var(--accent-green);
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
            position: relative;
        }
        .recommendation-box::before {
            content: "üí°";
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--bg-card);
            padding: 0 8px;
            font-size: 18px;
        }
        .recommendation-box h4 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--accent-green);
            font-weight: 600;
        }
        .recommendation-box ul {
            list-style: none;
            margin-bottom: 20px;
        }
        .recommendation-box li {
            padding: 8px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .recommendation-box li::before {
            content: "‚Üí";
            color: var(--accent-green);
            margin-right: 10px;
        }
        .recommendation-box .next-step {
            padding: 20px;
            background: var(--bg-dark);
            border-radius: 8px;
            font-size: 15px;
            border-left: 3px solid var(--accent-green);
        }
        .recommendation-box .next-step strong {
            color: var(--accent-green);
            font-size: 13px;
            display: block;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-secondary);
        }
        .empty-state svg { margin-bottom: 16px; opacity: 0.4; }
        .empty-state p { margin-bottom: 20px; }

        /* Processing State */
        .processing-screen {
            text-align: center;
            padding: 80px 40px;
        }
        .processing-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-screen h3 { font-size: 20px; margin-bottom: 8px; }
        .processing-screen p { color: var(--text-secondary); }

        /* Export Job Status */
        .job-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        .job-status-badge.queued { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .job-status-badge.processing { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .job-status-badge.completed { background: var(--accent-green-dim); color: var(--accent-green); }
        .job-status-badge.failed { background: var(--accent-red-dim); color: var(--accent-red); }

        .job-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .job-card.completed { border-color: var(--accent-green); }
        .job-card.failed { border-color: var(--accent-red); }
        .job-card.processing { border-color: var(--accent-blue); }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--accent-green);
            color: var(--bg-dark);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
        }
        .download-btn:hover { background: #00cc6e; }

        .prompt-box {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .copy-btn {
            padding: 8px 16px;
            background: var(--accent-blue-dim);
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .copy-btn:hover { background: var(--accent-blue); color: white; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            padding: 32px;
        }
        .modal h2 { font-size: 20px; margin-bottom: 8px; }
        .modal p { color: var(--text-secondary); margin-bottom: 24px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Configuration - use relative URLs so it works on any host
        const API_BASE = '';

        // API Helper
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // SVG Icons
        const Icons = {
            Dashboard: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
            ),
            Beaker: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M9 3h6v5l4 9H5l4-9V3z"/>
                    <path d="M9 3h6"/>
                </svg>
            ),
            Settings: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
                </svg>
            ),
            Book: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
            ),
            Plus: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            ),
            Play: () => (
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5,3 19,12 5,21"/>
                </svg>
            ),
            Check: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                    <polyline points="20,6 9,17 4,12"/>
                </svg>
            ),
            X: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            ),
            ChevronRight: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="9,18 15,12 9,6"/>
                </svg>
            ),
            ArrowDown: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <polyline points="19,12 12,19 5,12"/>
                </svg>
            ),
            Wand: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8L19 13M17.8 6.2L19 5M3 21l9-9M12.2 6.2L11 5"/>
                </svg>
            ),
            Download: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            ),
            Refresh: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M23 4v6h-6"/>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
            ),
        };

        // State definitions
        const EXPERIMENT_STATES = {
            DRAFT: 'draft',
            NEEDS_BATCH: 'needs-batch',
            GENERATING: 'generating',
            PENDING_APPROVAL: 'pending-approval',
            READY_TO_LAUNCH: 'ready-to-launch',
            LIVE: 'live',
            COMPLETED: 'completed',
            PAUSED: 'paused'
        };

        const STATE_LABELS = {
            'draft': 'Draft',
            'needs-batch': 'Needs Batch',
            'generating': 'Generating...',
            'pending-approval': 'Pending Approval',
            'ready-to-launch': 'Ready to Launch',
            'live': 'Live',
            'completed': 'Completed',
            'paused': 'Paused'
        };

        // Mock data
        const mockExperiments = [
            {
                id: 1,
                name: 'SlotFillr MVP Validation',
                product: 'SlotFillr',
                budget: 50,
                targetCPA: 15,
                platforms: ['instagram', 'tiktok'],
                state: EXPERIMENT_STATES.PENDING_APPROVAL,
                hypothesis: 'Automation framing beats pain framing',
                videos: [
                    { id: 1, hook: 'Your calendar has holes in it.', tags: ['Pain', 'Hook A', 'v1'], status: null },
                    { id: 2, hook: 'What if your no-shows rebooked themselves?', tags: ['Automation', 'Hook B', 'v1'], status: null },
                    { id: 3, hook: 'That empty 2pm slot costs you $150.', tags: ['Pain', 'Hook A', 'v2'], status: null },
                    { id: 4, hook: 'AI that fills your calendar while you sleep.', tags: ['Automation', 'Hook C', 'v1'], status: null },
                    { id: 5, hook: 'Empty slots don\'t reschedule themselves.', tags: ['Pain', 'Hook B', 'v1'], status: null },
                    { id: 6, hook: 'Set it once. Watch bookings roll in.', tags: ['Automation', 'Hook A', 'v3'], status: null },
                ]
            },
            {
                id: 2,
                name: 'Pain vs Automation Round 2',
                product: 'SlotFillr',
                budget: 75,
                targetCPA: 12,
                platforms: ['tiktok'],
                state: EXPERIMENT_STATES.NEEDS_BATCH,
                hypothesis: 'Urgency + automation outperforms pure pain',
                videos: []
            },
            {
                id: 3,
                name: 'Weekend Traffic Test',
                product: 'SlotFillr',
                budget: 100,
                targetCPA: 15,
                platforms: ['instagram', 'tiktok', 'facebook'],
                state: EXPERIMENT_STATES.LIVE,
                hypothesis: 'Weekend posts convert 20% better',
                videos: [],
                results: {
                    creatives: [
                        { name: 'video_02', ctr: 2.3, cpc: 0.72, cpa: 12.40, status: 'winner' },
                        { name: 'video_01', ctr: 1.6, cpc: 0.91, cpa: 15.10, status: null },
                        { name: 'video_04', ctr: 0.5, cpc: 1.80, cpa: null, status: 'paused' },
                    ],
                    funnel: [
                        { label: 'Clicks', count: 1200, dropPercent: null },
                        { label: 'AI Interaction Started', count: 744, dropPercent: 62 },
                        { label: 'Revenue Calc Completed', count: 357, dropPercent: 48 },
                        { label: 'Email + Phone Submitted', count: 111, dropPercent: 31 },
                    ]
                }
            }
        ];

        // Helper to get next action text
        function getNextAction(state) {
            switch(state) {
                case EXPERIMENT_STATES.DRAFT: return 'Configure';
                case EXPERIMENT_STATES.NEEDS_BATCH: return 'Generate Batch';
                case EXPERIMENT_STATES.GENERATING: return 'Generating...';
                case EXPERIMENT_STATES.PENDING_APPROVAL: return 'Review Videos';
                case EXPERIMENT_STATES.READY_TO_LAUNCH: return 'Launch';
                case EXPERIMENT_STATES.LIVE: return 'View Results';
                case EXPERIMENT_STATES.COMPLETED: return 'View Results';
                default: return 'Open';
            }
        }

        // Helper to get current step index
        function getCurrentStep(state) {
            switch(state) {
                case EXPERIMENT_STATES.DRAFT:
                case EXPERIMENT_STATES.NEEDS_BATCH:
                case EXPERIMENT_STATES.GENERATING:
                    return 0;
                case EXPERIMENT_STATES.PENDING_APPROVAL:
                    return 1;
                case EXPERIMENT_STATES.READY_TO_LAUNCH:
                    return 2;
                case EXPERIMENT_STATES.LIVE:
                case EXPERIMENT_STATES.COMPLETED:
                    return 3;
                default:
                    return 0;
            }
        }

        // State Badge Component
        function StateBadge({ state }) {
            return (
                <span className={`state-badge ${state}`}>
                    {STATE_LABELS[state] || state}
                </span>
            );
        }

        // Sidebar Component
        function Sidebar({ currentPage, onNavigate }) {
            return (
                <div className="sidebar">
                    <div className="logo">
                        <div className="logo-icon">TJ</div>
                        <div className="logo-text">Traction Jackson</div>
                    </div>

                    <div className="nav-section">
                        <div className="nav-label">Core</div>
                        <div
                            className={`nav-item ${currentPage === 'dashboard' ? 'active' : ''}`}
                            onClick={() => onNavigate('dashboard')}
                        >
                            <Icons.Dashboard />
                            Dashboard
                        </div>
                        <div
                            className={`nav-item ${currentPage === 'experiments' || currentPage === 'experiment' ? 'active' : ''}`}
                            onClick={() => onNavigate('experiments')}
                        >
                            <Icons.Beaker />
                            Experiments
                        </div>
                    </div>

                    <div className="nav-section">
                        <div className="nav-label">AI Tools</div>
                        <div
                            className={`nav-item ${currentPage === 'canva-ai' ? 'active' : ''}`}
                            onClick={() => onNavigate('canva-ai')}
                        >
                            <Icons.Wand />
                            Canva AI Export
                        </div>
                    </div>

                    <div className="nav-section">
                        <div className="nav-label">System</div>
                        <div className="nav-item" onClick={() => onNavigate('doctrine')}>
                            <Icons.Book />
                            Doctrine
                        </div>
                        <div className="nav-item" onClick={() => onNavigate('setup')}>
                            <Icons.Settings />
                            Setup
                        </div>
                    </div>
                </div>
            );
        }

        // Top Bar Component
        function TopBar({ title, meta, state }) {
            return (
                <div className="top-bar">
                    <div className="top-bar-left">
                        <span className="top-bar-title">{title}</span>
                        {meta && <span className="top-bar-meta">{meta}</span>}
                    </div>
                    {state && <StateBadge state={state} />}
                </div>
            );
        }

        // Stepper Component
        function Stepper({ currentStep, onStepClick }) {
            const steps = [
                { num: 1, label: 'Batch', desc: 'Generate' },
                { num: 2, label: 'Approve', desc: 'Review' },
                { num: 3, label: 'Launch', desc: 'Deploy' },
                { num: 4, label: 'Results', desc: 'Analyze' }
            ];

            return (
                <div className="stepper-container">
                    <div className="stepper">
                        {steps.map((step, idx) => {
                            const isCompleted = idx < currentStep;
                            const isActive = idx === currentStep;
                            const isLocked = idx > currentStep;

                            return (
                                <div
                                    key={step.num}
                                    className={`step ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}
                                    onClick={() => !isLocked && onStepClick(idx)}
                                >
                                    <div className="step-number">
                                        {isCompleted ? <Icons.Check /> : step.num}
                                    </div>
                                    <div className="step-label">{step.label}</div>
                                    <div className="step-status">
                                        {isCompleted ? '‚úì Complete' : isActive ? '‚óè Active' : '‚óã Locked'}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Dashboard Page
        function DashboardPage({ experiments, onExperimentClick, onNewExperiment }) {
            return (
                <>
                    <TopBar title="Dashboard" />
                    <div className="page-content">
                        <div className="dashboard-hero">
                            <h1>What do you want to test?</h1>
                            <p>Run structured experiments to find winning creative angles</p>
                            <button className="btn btn-primary btn-lg" onClick={onNewExperiment}>
                                <Icons.Plus /> Run New Experiment
                            </button>
                        </div>

                        <div className="section-header">
                            <h2 className="section-title">Active Experiments</h2>
                        </div>

                        <div className="experiment-list">
                            {experiments.map(exp => (
                                <div
                                    key={exp.id}
                                    className="experiment-card"
                                    onClick={() => onExperimentClick(exp)}
                                >
                                    <div className="experiment-info">
                                        <h3>{exp.name}</h3>
                                        <span className="experiment-meta">{exp.product} ‚Ä¢ {exp.platforms.join(', ')}</span>
                                    </div>
                                    <div className="experiment-stats">
                                        <span>${exp.budget}/day</span>
                                        <span>CPA: ${exp.targetCPA}</span>
                                    </div>
                                    <StateBadge state={exp.state} />
                                    <div style={{ textAlign: 'right' }}>
                                        <div className="next-action-hint">Your move ‚Üí</div>
                                        <button className="btn btn-primary" style={{ padding: '10px 20px' }}>
                                            {getNextAction(exp.state)} <Icons.ChevronRight />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </>
            );
        }

        // Experiments List Page
        function ExperimentsPage({ experiments, onExperimentClick, onNewExperiment }) {
            return (
                <>
                    <TopBar title="Experiments" />
                    <div className="page-content">
                        <div className="section-header">
                            <h2 className="section-title">All Experiments</h2>
                            <button className="btn btn-primary btn-sm" onClick={onNewExperiment}>
                                <Icons.Plus /> New Experiment
                            </button>
                        </div>

                        <div className="experiment-list">
                            {experiments.map(exp => (
                                <div
                                    key={exp.id}
                                    className="experiment-card"
                                    onClick={() => onExperimentClick(exp)}
                                >
                                    <div className="experiment-info">
                                        <h3>{exp.name}</h3>
                                        <span className="experiment-meta">{exp.product} ‚Ä¢ {exp.platforms.join(', ')}</span>
                                    </div>
                                    <div className="experiment-stats">
                                        <span>${exp.budget}/day</span>
                                        <span>CPA: ${exp.targetCPA}</span>
                                    </div>
                                    <StateBadge state={exp.state} />
                                    <div style={{ textAlign: 'right' }}>
                                        <div className="next-action-hint">Next step ‚Üí</div>
                                        <button className="btn btn-secondary" style={{ padding: '10px 20px' }}>
                                            {getNextAction(exp.state)} <Icons.ChevronRight />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </>
            );
        }

        // Step 1: Batch Generation
        function BatchStep({ experiment, onGenerate }) {
            const [config, setConfig] = useState({
                hypothesis: experiment.hypothesis || '',
                platforms: experiment.platforms || ['instagram'],
                tone: 'calm',
                variants: 6,
                cta: 'Join the private beta',
                landingUrl: 'https://slotfillr.ai',
                templateId: ''
            });

            const [isGenerating, setIsGenerating] = useState(false);
            const [templates, setTemplates] = useState([]);
            const [loadingTemplates, setLoadingTemplates] = useState(true);
            const [apiStatus, setApiStatus] = useState({ canva: false, elevenlabs: false });
            const [generationProgress, setGenerationProgress] = useState('');

            // Fetch templates and API status on mount
            useEffect(() => {
                async function loadData() {
                    try {
                        // Check API status
                        const status = await apiCall('/api/status');
                        setApiStatus(status.services || {});

                        // Fetch available templates
                        if (status.services?.canva) {
                            const templateData = await apiCall('/api/templates');
                            if (templateData.items) {
                                setTemplates(templateData.items);
                                if (templateData.items.length > 0) {
                                    setConfig(c => ({ ...c, templateId: templateData.items[0].id }));
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load templates:', error);
                    } finally {
                        setLoadingTemplates(false);
                    }
                }
                loadData();
            }, []);

            // Listen for OAuth callback messages from the popup window
            useEffect(() => {
                const handleOAuthMessage = async (event) => {
                    if (event.data?.type === 'canva_oauth_success') {
                        console.log('[TJ] Received OAuth token from popup');
                        try {
                            const response = await fetch('/api/connect/canva', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ token: event.data.accessToken })
                            });
                            if (response.ok) {
                                console.log('[TJ] Token sent to server successfully');
                                // Reload to fetch templates
                                window.location.reload();
                            }
                        } catch (err) {
                            console.error('[TJ] Failed to send token to server:', err);
                        }
                    } else if (event.data?.type === 'canva_oauth_error') {
                        console.error('[TJ] OAuth error:', event.data.error);
                        alert('Canva connection failed: ' + event.data.error);
                    }
                };
                window.addEventListener('message', handleOAuthMessage);
                return () => window.removeEventListener('message', handleOAuthMessage);
            }, []);

            const handleGenerate = async () => {
                if (!config.templateId) {
                    alert('Please select a template');
                    return;
                }

                setIsGenerating(true);
                setGenerationProgress('Starting campaign generation...');

                try {
                    // Generate voiceover scripts based on hypothesis
                    const scripts = generateScriptsFromHypothesis(config.hypothesis, config.variants);

                    setGenerationProgress('Calling Canva API to generate creatives...');

                    // Call the real API
                    const result = await apiCall('/api/campaign', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: experiment.name || 'TJ Campaign',
                            templateId: config.templateId,
                            creativeData: {
                                headline: config.cta,
                                subheadline: config.hypothesis,
                                cta: config.cta
                            },
                            voiceoverScripts: scripts
                        })
                    });

                    if (result.success && result.creatives) {
                        setGenerationProgress('Processing results...');
                        // Transform API results into video objects for the UI
                        const videos = result.creatives.map((creative, idx) => ({
                            id: idx + 1,
                            hook: scripts[idx] || `Version ${idx + 1}`,
                            tags: [config.platforms[0] || 'instagram', `v${idx + 1}`],
                            status: null,
                            // Real video data from API - prefer merged (finalVideoPath) over original
                            videoUrl: creative.videoUrl || null,
                            thumbnailUrl: creative.thumbnailUrl || null,
                            localVideoPath: creative.finalVideoPath || creative.localVideoPath || null,
                            voiceoverPath: creative.voiceover?.filePath || null,
                            designId: creative.creative?.designId || null,
                            hasAudioStream: creative.hasAudioStream !== undefined ? creative.hasAudioStream : null,
                            mergeError: creative.mergeError || null
                        }));
                        onGenerate({ ...config, generatedVideos: videos });
                    } else {
                        throw new Error(result.error || 'Generation failed');
                    }
                } catch (error) {
                    console.error('Generation error:', error);
                    setGenerationProgress(`Error: ${error.message}`);
                    // Fallback to mock generation for demo
                    setTimeout(() => {
                        onGenerate(config);
                    }, 1000);
                }
            };

            // Generate script variations based on hypothesis
            function generateScriptsFromHypothesis(hypothesis, count) {
                const templates = [
                    `Your calendar has holes in it. ${hypothesis ? hypothesis + '.' : ''} Stop losing revenue to no-shows.`,
                    `What if your no-shows rebooked themselves? That's exactly what we built.`,
                    `That empty 2pm slot costs you $150. Every. Single. Day.`,
                    `AI that fills your calendar while you sleep. No more chasing clients.`,
                    `Empty slots don't reschedule themselves. But now they can.`,
                    `Set it once. Watch bookings roll in. It's that simple.`,
                    `Stop chasing no-shows. Let AI do the heavy lifting.`,
                    `Every empty slot is money walking out the door. We fix that.`,
                    `Your receptionist can't work 24/7. AI can. And it never takes breaks.`,
                    `Cancellations happen. Refills should happen automatically too.`,
                    `How much did that 3pm no-show cost you? Let's make sure it never happens again.`,
                    `Fill your schedule while you focus on what matters - your clients.`
                ];
                return templates.slice(0, count);
            }

            if (isGenerating) {
                return (
                    <div className="processing-screen">
                        <div className="processing-spinner"></div>
                        <h3>Generating Creative Batch</h3>
                        <p>Creating {config.variants} video variants with Canva + ElevenLabs...</p>
                        <p style={{ marginTop: '16px', color: 'var(--accent-blue)', fontSize: '14px' }}>{generationProgress}</p>
                    </div>
                );
            }

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Generate Creative Batch</h2>
                        <p className="card-subtitle">Create video ads to test this hypothesis</p>
                    </div>

                    {/* API Status Indicators */}
                    <div style={{ display: 'flex', gap: '16px', marginBottom: '24px', flexWrap: 'wrap' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <div style={{
                                padding: '8px 16px',
                                borderRadius: '8px',
                                background: apiStatus.canva ? 'var(--accent-green-dim)' : 'var(--accent-red-dim)',
                                color: apiStatus.canva ? 'var(--accent-green)' : 'var(--accent-red)',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                {apiStatus.canva ? '‚úì' : '‚úó'} Canva {apiStatus.canva ? 'Connected' : 'Disconnected'}
                            </div>
                            {!apiStatus.canva ? (
                                <button
                                    onClick={() => window.open('http://127.0.0.1:3333/connect', '_blank')}
                                    style={{ padding: '8px 12px', borderRadius: '6px', background: 'var(--accent-blue)', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px' }}
                                >
                                    Connect Canva
                                </button>
                            ) : (
                                <button
                                    onClick={async () => { await fetch('/api/disconnect/canva', {method:'POST'}); window.location.reload(); }}
                                    style={{ padding: '8px 12px', borderRadius: '6px', background: 'var(--bg-dark)', color: 'var(--text-muted)', border: '1px solid var(--border)', cursor: 'pointer', fontSize: '12px' }}
                                >
                                    Disconnect
                                </button>
                            )}
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <div style={{
                                padding: '8px 16px',
                                borderRadius: '8px',
                                background: apiStatus.elevenlabs ? 'var(--accent-green-dim)' : 'var(--accent-red-dim)',
                                color: apiStatus.elevenlabs ? 'var(--accent-green)' : 'var(--accent-red)',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                {apiStatus.elevenlabs ? '‚úì' : '‚úó'} ElevenLabs {apiStatus.elevenlabs ? 'Connected' : 'Disconnected'}
                            </div>
                        </div>
                    </div>

                    {/* Template Selection */}
                    <div className="form-group">
                        <label className="form-label">Canva Template</label>
                        {loadingTemplates ? (
                            <div style={{ padding: '12px', color: 'var(--text-muted)' }}>Loading templates...</div>
                        ) : templates.length > 0 ? (
                            <select
                                className="form-select"
                                value={config.templateId}
                                onChange={e => setConfig({...config, templateId: e.target.value})}
                            >
                                {templates.map(t => (
                                    <option key={t.id} value={t.id}>{t.name || t.title || `Template ${t.id.slice(-8)}`}</option>
                                ))}
                            </select>
                        ) : (
                            <div style={{ padding: '12px', background: 'var(--accent-yellow-dim)', borderRadius: '8px', color: 'var(--accent-yellow)', fontSize: '13px' }}>
                                No Brand Templates found. Make sure the backend server is running and Canva is connected.
                                <br/><small style={{ color: 'var(--text-muted)' }}>Run: ./start.sh to start the server</small>
                            </div>
                        )}
                    </div>

                    <div className="form-group">
                        <label className="form-label">Hypothesis</label>
                        <select
                            className="form-select"
                            value={config.hypothesis}
                            onChange={e => setConfig({...config, hypothesis: e.target.value})}
                        >
                            <option value="Automation framing beats pain framing">Automation framing beats pain framing</option>
                            <option value="Pain framing drives more clicks">Pain framing drives more clicks</option>
                            <option value="Social proof increases conversions">Social proof increases conversions</option>
                        </select>
                    </div>

                    <div className="form-group">
                        <label className="form-label">Platforms</label>
                        <div className="checkbox-group">
                            {['instagram', 'tiktok', 'facebook'].map(platform => (
                                <label
                                    key={platform}
                                    className={`checkbox-item ${config.platforms.includes(platform) ? 'checked' : ''}`}
                                >
                                    <input
                                        type="checkbox"
                                        checked={config.platforms.includes(platform)}
                                        onChange={e => {
                                            if (e.target.checked) {
                                                setConfig({...config, platforms: [...config.platforms, platform]});
                                            } else {
                                                setConfig({...config, platforms: config.platforms.filter(p => p !== platform)});
                                            }
                                        }}
                                    />
                                    {config.platforms.includes(platform) ? '‚úì' : '‚óã'} {platform.charAt(0).toUpperCase() + platform.slice(1)}
                                </label>
                            ))}
                        </div>
                    </div>

                    <div className="form-row">
                        <div className="form-group">
                            <label className="form-label">Tone</label>
                            <select
                                className="form-select"
                                value={config.tone}
                                onChange={e => setConfig({...config, tone: e.target.value})}
                            >
                                <option value="calm">Calm</option>
                                <option value="urgent">Urgent</option>
                                <option value="playful">Playful</option>
                                <option value="professional">Professional</option>
                            </select>
                        </div>
                        <div className="form-group">
                            <label className="form-label">Variants</label>
                            <input
                                type="number"
                                className="form-input"
                                value={config.variants}
                                onChange={e => setConfig({...config, variants: parseInt(e.target.value)})}
                                min="1"
                                max="24"
                            />
                        </div>
                    </div>

                    <div className="form-group">
                        <label className="form-label">CTA Text</label>
                        <input
                            type="text"
                            className="form-input"
                            value={config.cta}
                            onChange={e => setConfig({...config, cta: e.target.value})}
                            placeholder="Join the private beta"
                        />
                    </div>

                    <div className="form-group">
                        <label className="form-label">Landing URL</label>
                        <input
                            type="url"
                            className="form-input"
                            value={config.landingUrl}
                            onChange={e => setConfig({...config, landingUrl: e.target.value})}
                            placeholder="https://yoursite.com"
                        />
                    </div>

                    <div style={{ textAlign: 'center', marginTop: '32px' }}>
                        <button className="btn btn-primary btn-lg" onClick={handleGenerate}>
                            Generate Batch
                        </button>
                    </div>
                </div>
            );
        }

        // Step 2: Approval
        function ApproveStep({ experiment, onApprove }) {
            const [videos, setVideos] = useState(
                experiment.videos.map(v => ({ ...v, status: v.status }))
            );

            const approved = videos.filter(v => v.status === 'approved').length;
            const rejected = videos.filter(v => v.status === 'rejected').length;

            const handleVideoAction = (videoId, action) => {
                setVideos(videos.map(v =>
                    v.id === videoId ? { ...v, status: action } : v
                ));
            };

            const handleContinue = () => {
                onApprove(videos.filter(v => v.status === 'approved'));
            };

            return (
                <>
                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">Review Generated Videos</h2>
                            <p className="card-subtitle">Approve only what you'd actually run</p>
                        </div>

                        <div className="video-grid">
                            {videos.map(video => {
                                // Determine video source - PREFER local merged path over CDN (CDN = silent Canva original)
                                const localPath = video.localVideoPath ? `${API_BASE}/campaigns/${video.localVideoPath.split('/campaigns/')[1] || ''}` : null;
                                const videoSrc = localPath || video.videoUrl || null;
                                const thumbSrc = video.thumbnailUrl || (video.localThumbnailPath ? `${API_BASE}/campaigns/${video.localThumbnailPath.split('/campaigns/')[1] || ''}` : null);
                                const voiceoverSrc = video.voiceoverPath ? `${API_BASE}/campaigns/${video.voiceoverPath.split('/campaigns/')[1] || ''}` : null;
                                const hasAudio = video.hasAudioStream !== false; // true or undefined = assume ok

                                return (
                                    <div
                                        key={video.id}
                                        className={`video-card ${video.status || ''}`}
                                    >
                                        <div className="video-thumbnail">
                                            {videoSrc ? (
                                                <video
                                                    controls
                                                    poster={thumbSrc || ''}
                                                    style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                                >
                                                    <source src={videoSrc} type="video/mp4" />
                                                    Your browser does not support video.
                                                </video>
                                            ) : thumbSrc ? (
                                                <img src={thumbSrc} alt="Thumbnail" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                            ) : (
                                                <div className="video-thumbnail-play">
                                                    <Icons.Play />
                                                </div>
                                            )}
                                            {video.hasAudioStream === false && (
                                                <div style={{
                                                    position: 'absolute', bottom: '8px', left: '8px', right: '8px',
                                                    background: 'rgba(255, 71, 87, 0.9)', color: 'white',
                                                    padding: '6px 10px', borderRadius: '6px',
                                                    fontSize: '11px', fontWeight: '600', textAlign: 'center'
                                                }}>
                                                    No audio track generated
                                                </div>
                                            )}
                                        </div>
                                        <div className="video-info">
                                            <div className="video-hook">"{video.hook}"</div>
                                            <div className="video-tags">
                                                {video.tags.map(tag => (
                                                    <span key={tag} className="video-tag">{tag}</span>
                                                ))}
                                                {video.designId && (
                                                    <span className="video-tag" style={{ background: 'var(--accent-blue-dim)', color: 'var(--accent-blue)' }}>
                                                        ID: {video.designId.slice(-6)}
                                                    </span>
                                                )}
                                            </div>

                                            {/* Voiceover player if available */}
                                            {voiceoverSrc && (
                                                <div style={{ marginBottom: '12px' }}>
                                                    <small style={{ color: 'var(--text-muted)', display: 'block', marginBottom: '4px' }}>Voiceover:</small>
                                                    <audio controls style={{ width: '100%', height: '32px' }}>
                                                        <source src={voiceoverSrc} type="audio/mpeg" />
                                                    </audio>
                                                </div>
                                            )}

                                            {video.status !== 'approved' && video.status !== 'rejected' && (
                                                <div className="video-actions">
                                                    <button
                                                        className="video-btn approve"
                                                        onClick={() => handleVideoAction(video.id, 'approved')}
                                                    >
                                                        ‚úì Approve
                                                    </button>
                                                    <button
                                                        className="video-btn reject"
                                                        onClick={() => handleVideoAction(video.id, 'rejected')}
                                                    >
                                                        ‚úï Reject
                                                    </button>
                                                </div>
                                            )}
                                            {video.status === 'approved' && (
                                                <button
                                                    className="btn btn-secondary btn-sm"
                                                    style={{ width: '100%' }}
                                                    onClick={() => handleVideoAction(video.id, null)}
                                                >
                                                    ‚úì Approved - Undo
                                                </button>
                                            )}
                                            {video.status === 'rejected' && (
                                                <button
                                                    className="btn btn-ghost btn-sm"
                                                    style={{ width: '100%' }}
                                                    onClick={() => handleVideoAction(video.id, null)}
                                                >
                                                    Rejected - Undo
                                                </button>
                                            )}

                                            {/* Download links */}
                                            {(videoSrc || voiceoverSrc) && (
                                                <div style={{ display: 'flex', gap: '8px', marginTop: '8px' }}>
                                                    {videoSrc && (
                                                        <a href={videoSrc} download style={{
                                                            flex: 1,
                                                            textAlign: 'center',
                                                            padding: '6px',
                                                            background: 'var(--bg-card-hover)',
                                                            borderRadius: '4px',
                                                            color: 'var(--text-secondary)',
                                                            textDecoration: 'none',
                                                            fontSize: '11px'
                                                        }}>
                                                            ‚Üì Video
                                                        </a>
                                                    )}
                                                    {voiceoverSrc && (
                                                        <a href={voiceoverSrc} download style={{
                                                            flex: 1,
                                                            textAlign: 'center',
                                                            padding: '6px',
                                                            background: 'var(--bg-card-hover)',
                                                            borderRadius: '4px',
                                                            color: 'var(--text-secondary)',
                                                            textDecoration: 'none',
                                                            fontSize: '11px'
                                                        }}>
                                                            ‚Üì Audio
                                                        </a>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="sticky-footer">
                        <div className="footer-stats">
                            <span>Approved: <strong className="approved">{approved}</strong></span>
                            <span>Rejected: <strong className="rejected">{rejected}</strong></span>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            {approved === 0 && (
                                <div className="approve-hint">Approve at least one video to continue</div>
                            )}
                            <button
                                className="btn btn-primary"
                                disabled={approved === 0}
                                onClick={handleContinue}
                                style={{ padding: '12px 28px' }}
                            >
                                Continue to Launch ‚Üí
                            </button>
                        </div>
                    </div>
                </>
            );
        }

        // Step 3: Launch Review
        function LaunchStep({ experiment, approvedVideos, onLaunch }) {
            const [isLaunching, setIsLaunching] = useState(false);

            const handleLaunch = () => {
                setIsLaunching(true);
                setTimeout(() => {
                    onLaunch();
                }, 2000);
            };

            if (isLaunching) {
                return (
                    <div className="processing-screen">
                        <div className="processing-spinner"></div>
                        <h3>Launching Experiment</h3>
                        <p>Creating campaigns on {experiment.platforms.join(' & ')}...</p>
                    </div>
                );
            }

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Launch Review</h2>
                        <p className="card-subtitle">Everything below will be created automatically</p>
                    </div>

                    <div className="review-section">
                        <div className="review-item">
                            <div className="review-label">Platforms</div>
                            <div className="review-value">
                                {experiment.platforms.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(', ')}
                            </div>
                        </div>
                        <div className="review-item">
                            <div className="review-label">Budget</div>
                            <div className="review-value">${experiment.budget}/day (even split)</div>
                        </div>
                        <div className="review-item">
                            <div className="review-label">Creatives</div>
                            <div className="review-value">{approvedVideos?.length || experiment.videos.filter(v => v.status === 'approved').length} approved videos</div>
                        </div>
                        <div className="review-item">
                            <div className="review-label">Tracking</div>
                            <div className="review-value" style={{ color: 'var(--accent-green)' }}>‚úì Pixel Connected</div>
                        </div>
                    </div>

                    <div className="card" style={{ background: 'var(--bg-dark)', marginTop: '24px' }}>
                        <h4 style={{ marginBottom: '16px', fontSize: '14px', color: 'var(--text-secondary)' }}>Guardrails</h4>
                        <ul className="guardrails-list">
                            <li>Pause creatives with CTR below 0.7% after 1,000 impressions</li>
                            <li>Flag creatives with CTR above 2.0% for early winner detection</li>
                            <li>Stop experiment if CPA exceeds ${experiment.targetCPA * 2} for 48 hours</li>
                        </ul>
                    </div>

                    <div className="launch-cta">
                        <p>Once launched, campaigns will be created on {experiment.platforms.join(' and ')} automatically.</p>
                        <button className="btn btn-primary btn-lg" onClick={handleLaunch}>
                            Launch Experiment
                        </button>
                        <p style={{ marginTop: '20px', fontSize: '13px', color: 'var(--text-muted)' }}>
                            You can pause or stop this experiment at any time.
                        </p>
                    </div>
                </div>
            );
        }

        // Step 4: Results
        function ResultsStep({ experiment }) {
            const results = experiment.results || {
                creatives: [
                    { name: 'video_02', ctr: 2.3, cpc: 0.72, cpa: 12.40, status: 'winner' },
                    { name: 'video_01', ctr: 1.6, cpc: 0.91, cpa: 15.10, status: null },
                    { name: 'video_04', ctr: 0.5, cpc: 1.80, cpa: null, status: 'paused' },
                ],
                funnel: [
                    { label: 'Clicks', count: 1200, dropPercent: null },
                    { label: 'AI Interaction Started', count: 744, dropPercent: 62 },
                    { label: 'Revenue Calc Completed', count: 357, dropPercent: 48 },
                    { label: 'Email + Phone Submitted', count: 111, dropPercent: 31 },
                ]
            };

            const biggestDrop = results.funnel.reduce((max, step, idx) => {
                if (idx === 0) return max;
                const drop = 100 - step.dropPercent;
                return drop > max.drop ? { idx, drop } : max;
            }, { idx: -1, drop: 0 });

            return (
                <>
                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">Creative Performance</h2>
                        </div>
                        <table className="results-table">
                            <thead>
                                <tr>
                                    <th>Video</th>
                                    <th>CTR</th>
                                    <th>CPC</th>
                                    <th>CPA</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {results.creatives.map(c => (
                                    <tr key={c.name} className={c.status === 'winner' ? 'winner' : ''}>
                                        <td>{c.name}</td>
                                        <td>{c.ctr}%</td>
                                        <td>${c.cpc}</td>
                                        <td>{c.cpa ? `$${c.cpa}` : '‚Äî'}</td>
                                        <td>
                                            {c.status && (
                                                <span className={`status-pill ${c.status}`}>
                                                    {c.status === 'winner' ? '‚òÖ Winner' : 'Paused'}
                                                </span>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">Funnel Drop-off</h2>
                        </div>
                        <div className="funnel">
                            {results.funnel.map((step, idx) => (
                                <React.Fragment key={step.label}>
                                    <div className={`funnel-step ${idx === biggestDrop.idx ? 'highlight' : ''}`}>
                                        <span className="funnel-label">{step.label}</span>
                                        <span className="funnel-count">{step.count.toLocaleString()}</span>
                                    </div>
                                    {idx < results.funnel.length - 1 && (
                                        <div className="funnel-arrow">
                                            ‚Üì {results.funnel[idx + 1].dropPercent}%
                                        </div>
                                    )}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>

                    <div className="recommendation-box">
                        <h4>What We Learned</h4>
                        <ul>
                            <li>Automation framing clearly outperformed pain framing</li>
                            <li>Users who completed the revenue calculation converted 2.4√ó higher</li>
                            <li>Biggest drop-off occurs before AI engagement</li>
                        </ul>
                        <div className="next-step">
                            <strong>Recommended Next Step</strong>
                            Generate a new batch expanding automation framing ‚Äî double down on what's working.
                        </div>
                    </div>

                    <div className="action-buttons">
                        <button className="btn btn-primary" style={{ padding: '14px 28px' }}>
                            Generate Iteration Batch ‚Üí
                        </button>
                        <button className="btn btn-secondary">New Hypothesis</button>
                        <button className="btn btn-secondary">Increase Budget</button>
                    </div>
                </>
            );
        }

        // Experiment Flow View
        function ExperimentFlowView({ experiment, onBack, onUpdateExperiment }) {
            const [currentStep, setCurrentStep] = useState(getCurrentStep(experiment.state));
            const [approvedVideos, setApprovedVideos] = useState([]);

            const handleGenerate = (config) => {
                // Check if we have real generated videos from the API
                if (config.generatedVideos && config.generatedVideos.length > 0) {
                    // Use real videos from API
                    const updatedExperiment = {
                        ...experiment,
                        state: EXPERIMENT_STATES.PENDING_APPROVAL,
                        hypothesis: config.hypothesis || experiment.hypothesis,
                        platforms: config.platforms || experiment.platforms,
                        videos: config.generatedVideos
                    };
                    onUpdateExperiment(updatedExperiment);
                    setCurrentStep(1);
                    return;
                }

                // Fallback: Generate mock videos based on the config
                const hooks = [
                    { hook: 'Your calendar has holes in it.', tags: ['Pain', 'Hook A'] },
                    { hook: 'What if your no-shows rebooked themselves?', tags: ['Automation', 'Hook B'] },
                    { hook: 'That empty 2pm slot costs you $150.', tags: ['Pain', 'Hook A'] },
                    { hook: 'AI that fills your calendar while you sleep.', tags: ['Automation', 'Hook C'] },
                    { hook: "Empty slots don't reschedule themselves.", tags: ['Pain', 'Hook B'] },
                    { hook: 'Set it once. Watch bookings roll in.', tags: ['Automation', 'Hook A'] },
                    { hook: 'Stop chasing no-shows. Let AI do it.', tags: ['Automation', 'Hook D'] },
                    { hook: 'Every empty slot is money walking out the door.', tags: ['Pain', 'Hook C'] },
                    { hook: "Your receptionist can't work 24/7. AI can.", tags: ['Automation', 'Hook E'] },
                    { hook: 'Cancellations happen. Refills should too.', tags: ['Automation', 'Hook F'] },
                    { hook: 'How much did that 3pm no-show cost you?', tags: ['Pain', 'Hook D'] },
                    { hook: 'Fill your schedule while you focus on clients.', tags: ['Automation', 'Hook G'] },
                ];

                const generatedVideos = hooks.slice(0, config.variants || 6).map((h, idx) => ({
                    id: idx + 1,
                    hook: h.hook,
                    tags: [...h.tags, `v${Math.floor(idx / 2) + 1}`],
                    status: null,
                    // No real video data - will show placeholder
                    videoUrl: null,
                    thumbnailUrl: null
                }));

                const updatedExperiment = {
                    ...experiment,
                    state: EXPERIMENT_STATES.PENDING_APPROVAL,
                    hypothesis: config.hypothesis || experiment.hypothesis,
                    platforms: config.platforms || experiment.platforms,
                    videos: generatedVideos
                };

                onUpdateExperiment(updatedExperiment);
                setCurrentStep(1);
            };

            const handleApprove = (approved) => {
                setApprovedVideos(approved);
                onUpdateExperiment({ ...experiment, state: EXPERIMENT_STATES.READY_TO_LAUNCH });
                setCurrentStep(2);
            };

            const handleLaunch = () => {
                onUpdateExperiment({ ...experiment, state: EXPERIMENT_STATES.LIVE });
                setCurrentStep(3);
            };

            const handleStepClick = (stepIdx) => {
                if (stepIdx <= getCurrentStep(experiment.state)) {
                    setCurrentStep(stepIdx);
                }
            };

            return (
                <>
                    <TopBar
                        title={experiment.name}
                        meta={`$${experiment.budget}/day ‚Ä¢ Target CPA: $${experiment.targetCPA} ‚Ä¢ ${experiment.platforms.join(' + ')}`}
                        state={experiment.state}
                    />
                    <Stepper currentStep={currentStep} onStepClick={handleStepClick} />
                    <div className="page-content" style={{ paddingBottom: currentStep === 1 ? '100px' : '32px' }}>
                        {currentStep === 0 && (
                            <BatchStep experiment={experiment} onGenerate={handleGenerate} />
                        )}
                        {currentStep === 1 && (
                            <ApproveStep experiment={experiment} onApprove={handleApprove} />
                        )}
                        {currentStep === 2 && (
                            <LaunchStep experiment={experiment} approvedVideos={approvedVideos} onLaunch={handleLaunch} />
                        )}
                        {currentStep === 3 && (
                            <ResultsStep experiment={experiment} />
                        )}
                    </div>
                </>
            );
        }

        // Canva AI Export Page - Job-based async export flow
        function CanvaAIPage() {
            const [designId, setDesignId] = useState('');
            const [campaignName, setCampaignName] = useState('');
            const [jobs, setJobs] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [error, setError] = useState(null);
            const [apiStatus, setApiStatus] = useState({ canva: false });

            // Polling interval ref
            const pollingRef = React.useRef(null);

            // Load API status and existing jobs on mount
            useEffect(() => {
                async function loadData() {
                    try {
                        const status = await apiCall('/api/status');
                        setApiStatus(status.services || {});

                        // Load existing jobs
                        const jobsData = await apiCall('/api/ai/export-jobs');
                        if (jobsData.jobs) {
                            setJobs(jobsData.jobs);
                        }
                    } catch (err) {
                        console.error('Failed to load data:', err);
                    }
                }
                loadData();

                // Cleanup polling on unmount
                return () => {
                    if (pollingRef.current) {
                        clearInterval(pollingRef.current);
                    }
                };
            }, []);

            // Start polling when there are processing/queued jobs
            useEffect(() => {
                const activeJobs = jobs.filter(j => j.status === 'queued' || j.status === 'processing');

                if (activeJobs.length > 0 && !pollingRef.current) {
                    pollingRef.current = setInterval(async () => {
                        try {
                            const jobsData = await apiCall('/api/ai/export-jobs');
                            if (jobsData.jobs) {
                                setJobs(jobsData.jobs);
                            }

                            // Stop polling if no more active jobs
                            const stillActive = jobsData.jobs.filter(j => j.status === 'queued' || j.status === 'processing');
                            if (stillActive.length === 0 && pollingRef.current) {
                                clearInterval(pollingRef.current);
                                pollingRef.current = null;
                            }
                        } catch (err) {
                            console.error('Polling error:', err);
                        }
                    }, 2500); // Poll every 2.5 seconds
                }

                if (activeJobs.length === 0 && pollingRef.current) {
                    clearInterval(pollingRef.current);
                    pollingRef.current = null;
                }
            }, [jobs]);

            // Extract design ID from URL or raw ID
            const extractDesignId = (input) => {
                if (!input) return '';
                // If it looks like just an ID (starts with DA)
                if (/^DA[A-Za-z0-9_-]+$/.test(input.trim())) {
                    return input.trim();
                }
                // Extract from URL
                const match = input.match(/design\/([A-Za-z0-9_-]+)/);
                return match ? match[1] : input.trim();
            };

            const handleExport = async () => {
                const id = extractDesignId(designId);
                if (!id) {
                    setError('Please enter a valid Canva design ID or URL');
                    return;
                }

                setIsSubmitting(true);
                setError(null);

                try {
                    const result = await apiCall('/api/ai/export-jobs', {
                        method: 'POST',
                        body: JSON.stringify({
                            designId: id,
                            campaignName: campaignName || 'canva-ai-export'
                        })
                    });

                    if (result.jobId) {
                        // Add to jobs list
                        setJobs(prev => [result, ...prev]);
                        setDesignId('');
                        setCampaignName('');
                    } else {
                        setError(result.error || 'Failed to create export job');
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleRetry = async (job) => {
                try {
                    const result = await apiCall('/api/ai/export-jobs', {
                        method: 'POST',
                        body: JSON.stringify({
                            designId: job.designId,
                            campaignName: job.campaignName || 'retry-export'
                        })
                    });

                    if (result.jobId) {
                        setJobs(prev => [result, ...prev.filter(j => j.jobId !== job.jobId)]);
                    }
                } catch (err) {
                    console.error('Retry failed:', err);
                }
            };

            const getStatusText = (status) => {
                switch (status) {
                    case 'queued': return 'Queued...';
                    case 'processing': return 'Exporting...';
                    case 'completed': return 'Ready';
                    case 'failed': return 'Failed';
                    default: return status;
                }
            };

            const getStatusIcon = (status) => {
                switch (status) {
                    case 'queued': return '‚è≥';
                    case 'processing': return '‚öôÔ∏è';
                    case 'completed': return '‚úì';
                    case 'failed': return '‚úï';
                    default: return '‚óã';
                }
            };

            return (
                <>
                    <TopBar title="Canva AI Export" />
                    <div className="page-content">
                        {/* API Status */}
                        <div style={{ marginBottom: '24px' }}>
                            <div style={{
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '8px',
                                padding: '8px 16px',
                                borderRadius: '8px',
                                background: apiStatus.canva ? 'var(--accent-green-dim)' : 'var(--accent-red-dim)',
                                color: apiStatus.canva ? 'var(--accent-green)' : 'var(--accent-red)',
                                fontSize: '13px',
                                fontWeight: '500'
                            }}>
                                {apiStatus.canva ? '‚úì' : '‚úó'} Canva {apiStatus.canva ? 'Connected' : 'Disconnected'}
                            </div>
                            {!apiStatus.canva && (
                                <button
                                    onClick={() => window.open('http://127.0.0.1:3333/connect', '_blank')}
                                    style={{ marginLeft: '12px', padding: '8px 12px', borderRadius: '6px', background: 'var(--accent-blue)', color: 'white', border: 'none', cursor: 'pointer', fontSize: '12px' }}
                                >
                                    Connect Canva
                                </button>
                            )}
                        </div>

                        {/* Export Form */}
                        <div className="card">
                            <div className="card-header">
                                <h2 className="card-title">Export Design from Canva AI</h2>
                                <p className="card-subtitle">
                                    Paste a Canva design ID or URL to export it as MP4
                                </p>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Design ID or URL</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="DAHAcoItOIY or https://www.canva.com/design/DAHAcoItOIY/view"
                                    value={designId}
                                    onChange={e => setDesignId(e.target.value)}
                                />
                                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '6px' }}>
                                    Get this from your Canva AI design URL after generating a video
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Campaign Name (optional)</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="my-campaign"
                                    value={campaignName}
                                    onChange={e => setCampaignName(e.target.value)}
                                />
                            </div>

                            {error && (
                                <div style={{
                                    padding: '12px 16px',
                                    background: 'var(--accent-red-dim)',
                                    borderRadius: '8px',
                                    color: 'var(--accent-red)',
                                    fontSize: '13px',
                                    marginBottom: '16px'
                                }}>
                                    {error}
                                </div>
                            )}

                            <button
                                className="btn btn-primary btn-lg"
                                onClick={handleExport}
                                disabled={isSubmitting || !apiStatus.canva}
                                style={{ width: '100%' }}
                            >
                                {isSubmitting ? (
                                    <>
                                        <span style={{ display: 'inline-block', animation: 'spin 1s linear infinite' }}>‚öôÔ∏è</span>
                                        Creating Export Job...
                                    </>
                                ) : (
                                    <>
                                        <Icons.Download /> Export as MP4
                                    </>
                                )}
                            </button>
                        </div>

                        {/* Export Jobs List */}
                        {jobs.length > 0 && (
                            <div className="card" style={{ marginTop: '24px' }}>
                                <div className="card-header">
                                    <h2 className="card-title">Export Jobs</h2>
                                    <p className="card-subtitle">Track your video exports</p>
                                </div>

                                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                    {jobs.map(job => (
                                        <div
                                            key={job.jobId}
                                            className={`job-card ${job.status}`}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                                <div>
                                                    <div style={{ fontSize: '14px', fontWeight: '500', marginBottom: '4px' }}>
                                                        Design: {job.designId?.slice(0, 12)}...
                                                    </div>
                                                    <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                                                        {job.campaignName} ‚Ä¢ {new Date(job.createdAt).toLocaleString()}
                                                    </div>
                                                </div>
                                                <span className={`job-status-badge ${job.status}`}>
                                                    {getStatusIcon(job.status)} {getStatusText(job.status)}
                                                </span>
                                            </div>

                                            {/* Progress indicator for processing */}
                                            {job.status === 'processing' && (
                                                <div style={{
                                                    height: '4px',
                                                    background: 'var(--bg-dark)',
                                                    borderRadius: '2px',
                                                    overflow: 'hidden',
                                                    marginBottom: '12px'
                                                }}>
                                                    <div style={{
                                                        width: `${job.progress || 50}%`,
                                                        height: '100%',
                                                        background: 'var(--accent-blue)',
                                                        transition: 'width 0.3s ease',
                                                        animation: 'pulse 2s ease-in-out infinite'
                                                    }}></div>
                                                </div>
                                            )}

                                            {/* Error message */}
                                            {job.status === 'failed' && job.error && (
                                                <div style={{
                                                    padding: '8px 12px',
                                                    background: 'var(--accent-red-dim)',
                                                    borderRadius: '6px',
                                                    fontSize: '12px',
                                                    color: 'var(--accent-red)',
                                                    marginBottom: '12px'
                                                }}>
                                                    {job.error}
                                                </div>
                                            )}

                                            {/* Video preview and download for completed jobs */}
                                            {job.status === 'completed' && job.downloadUrls && job.downloadUrls.length > 0 && (
                                                <div>
                                                    {/* Video preview - streams directly from Canva CDN */}
                                                    <div style={{
                                                        marginBottom: '12px',
                                                        borderRadius: '8px',
                                                        overflow: 'hidden',
                                                        background: 'var(--bg-dark)'
                                                    }}>
                                                        <video
                                                            controls
                                                            style={{ width: '100%', maxHeight: '300px' }}
                                                            src={job.downloadUrls[0]}
                                                        >
                                                            Your browser does not support video.
                                                        </video>
                                                    </div>

                                                    {/* Download buttons - direct CDN links */}
                                                    <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                                                        {job.downloadUrls.map((url, idx) => (
                                                            <a
                                                                key={idx}
                                                                href={url}
                                                                className="download-btn"
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                            >
                                                                <Icons.Download /> Download Video {job.downloadUrls.length > 1 ? `#${idx + 1}` : ''}
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Retry button for failed jobs */}
                                            {job.status === 'failed' && (
                                                <button
                                                    onClick={() => handleRetry(job)}
                                                    className="btn btn-secondary"
                                                    style={{ marginTop: '8px' }}
                                                >
                                                    <Icons.Refresh /> Retry Export
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Help Section */}
                        <div className="card" style={{ marginTop: '24px', background: 'var(--bg-dark)' }}>
                            <h3 style={{ fontSize: '16px', marginBottom: '16px', color: 'var(--accent-blue)' }}>How to Use</h3>
                            <ol style={{ color: 'var(--text-secondary)', lineHeight: 1.8, paddingLeft: '20px' }}>
                                <li>Go to <a href="https://www.canva.com/ai" target="_blank" rel="noopener noreferrer" style={{ color: 'var(--accent-blue)' }}>canva.com/ai</a> and generate a video design</li>
                                <li>Open your generated design in the Canva Editor</li>
                                <li>Copy the design ID from the URL (e.g., <code style={{ background: 'var(--bg-card)', padding: '2px 6px', borderRadius: '4px' }}>DAHAcoItOIY</code>)</li>
                                <li>Paste it above and click "Export as MP4"</li>
                                <li>Wait for the export to complete, then download your video</li>
                            </ol>
                        </div>
                    </div>
                </>
            );
        }

        // New Experiment Modal
        function NewExperimentModal({ onClose, onCreate }) {
            const [name, setName] = useState('');
            const [hypothesis, setHypothesis] = useState('');
            const [product, setProduct] = useState('SlotFillr');

            const handleCreate = () => {
                onCreate({
                    id: Date.now(),
                    name: name || 'New Experiment',
                    product,
                    budget: 50,
                    targetCPA: 15,
                    platforms: ['instagram'],
                    state: EXPERIMENT_STATES.NEEDS_BATCH,
                    hypothesis: hypothesis,
                    videos: []
                });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <h2>New Experiment</h2>
                        <p>Define what you're testing and why</p>

                        <div className="form-group">
                            <label className="form-label">Experiment Name</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="e.g., Pain vs Automation Test"
                                value={name}
                                onChange={e => setName(e.target.value)}
                                autoFocus
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Hypothesis <span style={{ color: 'var(--text-muted)', fontWeight: 400 }}>(recommended)</span></label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="e.g., Automation framing will outperform pain framing for med spas"
                                value={hypothesis}
                                onChange={e => setHypothesis(e.target.value)}
                            />
                            <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '6px' }}>
                                Write this as a testable claim. This will anchor your "What We Learned" later.
                            </div>
                        </div>

                        <div className="form-group">
                            <label className="form-label">Product</label>
                            <select
                                className="form-select"
                                value={product}
                                onChange={e => setProduct(e.target.value)}
                            >
                                <option value="SlotFillr">SlotFillr</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div className="modal-actions">
                            <button className="btn btn-ghost" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={handleCreate}>Create Experiment</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Setup / Integrations Page - REAL health checks
        function SetupPage() {
            const [integrations, setIntegrations] = useState(null);
            const [loading, setLoading] = useState(true);
            const [testing, setTesting] = useState(null); // which integration is being tested

            const fetchStatus = async () => {
                setLoading(true);
                try {
                    const result = await apiCall('/api/integrations/status');
                    setIntegrations(result);
                } catch (err) {
                    console.error('Failed to fetch integration status:', err);
                    setIntegrations({
                        canva: { connected: false, reason: 'Failed to reach server' },
                        elevenlabs: { connected: false, reason: 'Failed to reach server' },
                        ffmpeg: { available: false, version: null, reason: 'Failed to reach server' }
                    });
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchStatus(); }, []);

            const handleTest = async (service) => {
                setTesting(service);
                await fetchStatus();
                setTesting(null);
            };

            const StatusRow = ({ name, connected, reason, onTest, isTesting }) => (
                <div style={{
                    display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                    padding: '16px 20px', background: 'var(--bg-dark)', borderRadius: '8px',
                    border: '1px solid ' + (connected ? 'rgba(0,255,136,0.2)' : 'rgba(255,71,87,0.2)')
                }}>
                    <div>
                        <div style={{ fontWeight: 600, marginBottom: '4px' }}>{name}</div>
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{reason}</div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <span style={{
                            padding: '4px 12px', borderRadius: '20px', fontSize: '12px', fontWeight: '600',
                            background: connected ? 'var(--accent-green-dim)' : 'var(--accent-red-dim)',
                            color: connected ? 'var(--accent-green)' : 'var(--accent-red)'
                        }}>
                            {connected ? 'Connected' : 'Disconnected'}
                        </span>
                        <button
                            className="btn btn-secondary btn-sm"
                            onClick={onTest}
                            disabled={isTesting}
                            style={{ padding: '6px 12px', fontSize: '12px', minWidth: '60px' }}
                        >
                            {isTesting ? '...' : 'Test'}
                        </button>
                    </div>
                </div>
            );

            return (
                <>
                    <TopBar title="Setup" />
                    <div className="page-content">
                        <div className="card">
                            <div className="card-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <h2 className="card-title">Integrations</h2>
                                    <p className="card-subtitle">Real-time connection status for all services</p>
                                </div>
                                <button className="btn btn-secondary btn-sm" onClick={fetchStatus} disabled={loading}>
                                    <Icons.Refresh /> {loading ? 'Checking...' : 'Refresh All'}
                                </button>
                            </div>

                            {loading && !integrations ? (
                                <div style={{ textAlign: 'center', padding: '40px', color: 'var(--text-muted)' }}>
                                    Checking integrations...
                                </div>
                            ) : (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                    <StatusRow
                                        name="Canva"
                                        connected={integrations?.canva?.connected}
                                        reason={integrations?.canva?.reason || 'Unknown'}
                                        onTest={() => handleTest('canva')}
                                        isTesting={testing === 'canva'}
                                    />
                                    <StatusRow
                                        name="ElevenLabs (Voice AI)"
                                        connected={integrations?.elevenlabs?.connected}
                                        reason={integrations?.elevenlabs?.reason || 'Unknown'}
                                        onTest={() => handleTest('elevenlabs')}
                                        isTesting={testing === 'elevenlabs'}
                                    />
                                    <StatusRow
                                        name="FFmpeg (Audio/Video Merge)"
                                        connected={integrations?.ffmpeg?.available}
                                        reason={integrations?.ffmpeg?.reason || 'Unknown'}
                                        onTest={() => handleTest('ffmpeg')}
                                        isTesting={testing === 'ffmpeg'}
                                    />
                                    <div style={{
                                        display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                        padding: '16px 20px', background: 'var(--bg-dark)', borderRadius: '8px',
                                        border: '1px solid var(--border)', opacity: 0.5
                                    }}>
                                        <div>
                                            <div style={{ fontWeight: 600, marginBottom: '4px' }}>Meta (Instagram/Facebook)</div>
                                            <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Coming soon</div>
                                        </div>
                                        <span style={{
                                            padding: '4px 12px', borderRadius: '20px', fontSize: '12px', fontWeight: '600',
                                            background: 'var(--bg-card-hover)', color: 'var(--text-muted)'
                                        }}>Not Yet Available</span>
                                    </div>
                                    <div style={{
                                        display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                        padding: '16px 20px', background: 'var(--bg-dark)', borderRadius: '8px',
                                        border: '1px solid var(--border)', opacity: 0.5
                                    }}>
                                        <div>
                                            <div style={{ fontWeight: 600, marginBottom: '4px' }}>TikTok Ads</div>
                                            <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Coming soon</div>
                                        </div>
                                        <span style={{
                                            padding: '4px 12px', borderRadius: '20px', fontSize: '12px', fontWeight: '600',
                                            background: 'var(--bg-card-hover)', color: 'var(--text-muted)'
                                        }}>Not Yet Available</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </>
            );
        }

        // Main App
        function App() {
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [experiments, setExperiments] = useState(mockExperiments);
            const [selectedExperiment, setSelectedExperiment] = useState(null);
            const [showNewModal, setShowNewModal] = useState(false);

            const handleNavigate = (page) => {
                setCurrentPage(page);
                setSelectedExperiment(null);
            };

            const handleExperimentClick = (experiment) => {
                setSelectedExperiment(experiment);
                setCurrentPage('experiment');
            };

            const handleUpdateExperiment = (updated) => {
                setExperiments(experiments.map(e => e.id === updated.id ? updated : e));
                setSelectedExperiment(updated);
            };

            const handleCreateExperiment = (newExp) => {
                setExperiments([newExp, ...experiments]);
                setSelectedExperiment(newExp);
                setCurrentPage('experiment');
                setShowNewModal(false);
            };

            return (
                <div className="app-container">
                    <Sidebar currentPage={currentPage} onNavigate={handleNavigate} />
                    <div className="main-content">
                        {currentPage === 'dashboard' && (
                            <DashboardPage
                                experiments={experiments}
                                onExperimentClick={handleExperimentClick}
                                onNewExperiment={() => setShowNewModal(true)}
                            />
                        )}
                        {currentPage === 'experiments' && (
                            <ExperimentsPage
                                experiments={experiments}
                                onExperimentClick={handleExperimentClick}
                                onNewExperiment={() => setShowNewModal(true)}
                            />
                        )}
                        {currentPage === 'experiment' && selectedExperiment && (
                            <ExperimentFlowView
                                experiment={selectedExperiment}
                                onBack={() => handleNavigate('experiments')}
                                onUpdateExperiment={handleUpdateExperiment}
                            />
                        )}
                        {currentPage === 'doctrine' && (
                            <>
                                <TopBar title="Doctrine" />
                                <div className="page-content">
                                    <div className="card">
                                        <div className="card-header">
                                            <h2 className="card-title">Traction Jackson Doctrine</h2>
                                            <p className="card-subtitle">The principles that guide every experiment</p>
                                        </div>
                                        <div style={{ color: 'var(--text-secondary)', lineHeight: 1.7 }}>
                                            <p style={{ marginBottom: '16px' }}><strong style={{ color: 'var(--accent-green)' }}>1. Experiments, not campaigns.</strong> Every dollar spent is a hypothesis test.</p>
                                            <p style={{ marginBottom: '16px' }}><strong style={{ color: 'var(--accent-green)' }}>2. Human approval is mandatory.</strong> AI generates, humans decide.</p>
                                            <p style={{ marginBottom: '16px' }}><strong style={{ color: 'var(--accent-green)' }}>3. One obvious next action.</strong> Never leave the operator wondering what to do.</p>
                                            <p style={{ marginBottom: '16px' }}><strong style={{ color: 'var(--accent-green)' }}>4. Guardrails are automatic.</strong> Kill bad creative before it wastes budget.</p>
                                            <p><strong style={{ color: 'var(--accent-green)' }}>5. Learn and iterate.</strong> Every experiment informs the next one.</p>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                        {currentPage === 'setup' && (
                            <SetupPage />
                        )}
                        {currentPage === 'canva-ai' && (
                            <CanvaAIPage />
                        )}
                    </div>

                    {showNewModal && (
                        <NewExperimentModal
                            onClose={() => setShowNewModal(false)}
                            onCreate={handleCreateExperiment}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
